<section class="ventas-shell">
  <div class="ventas-hero glass-panel">
    <div class="hero-copy">
      <p class="hero-kicker text-uppercase">Ventas</p>
      <h1 class="hero-title">Seguimiento comercial</h1>
      <p class="hero-lede">
        Controla ventas al contado y crédito con filtros rápidos y la misma estética envolvente del resto de SICOIL.
      </p>
      <div class="hero-metrics">
        <div class="metric-chip">
          <span>En esta vista</span>
          <strong>{{ ventas.length }}</strong>
        </div>
        <div class="metric-chip">
          <span>Total filtrados</span>
          <strong>{{ totalElementos }}</strong>
        </div>
        <div class="metric-chip">
          <span>Estado filtro</span>
          <strong>
            {{
              filtroEstado === 'predeterminado'
                ? 'Todos'
                : filtroEstado === 'activas'
                  ? 'Solo activas'
                  : 'Solo anuladas'
            }}
          </strong>
        </div>
      </div>
      <div class="hero-actions">
        <button
          type="button"
          class="btn btn-primary d-inline-flex align-items-center gap-2"
          (click)="registrarVenta()"
          [disabled]="registrandoVenta"
        >
          <ng-container *ngIf="!registrandoVenta; else registrandoVentaTpl">
            <i class="bi bi-cash-stack"></i>
            <span>Registrar venta</span>
          </ng-container>
        </button>
      </div>
    </div>

    <form class="ventas-filters" novalidate (ngSubmit)="buscarVentas()">
      <p class="form-label">Filtros de búsqueda</p>
      <div class="filter-grid">
        <div class="filter-control">
          <label class="form-label" for="filtro-cliente">Cliente</label>
          <input
            type="text"
            id="filtro-cliente"
            class="form-control"
            placeholder="Nombre o identificación"
            [(ngModel)]="filtroNombreCliente"
            name="filtroNombreCliente"
          />
        </div>
        <div class="filter-control">
          <label class="form-label" for="filtro-usuario">Registrado por</label>
          <input
            type="text"
            id="filtro-usuario"
            class="form-control"
            placeholder="Nombre del usuario"
            [(ngModel)]="filtroNombreUsuario"
            name="filtroNombreUsuario"
          />
        </div>
        <div class="filter-control">
          <label class="form-label" for="filtro-tipo">Tipo de venta</label>
          <select id="filtro-tipo" class="form-select" [(ngModel)]="filtroTipoVenta" name="filtroTipoVenta">
            <option value="">Todos</option>
            <option value="CONTADO">Contado</option>
            <option value="CREDITO">Crédito</option>
          </select>
        </div>
        <div class="filter-control">
          <label class="form-label" for="filtro-estado">Estado</label>
          <select id="filtro-estado" class="form-select" [(ngModel)]="filtroEstado" name="filtroEstado">
            <option value="predeterminado">Defecto</option>
            <option value="activas">Activas</option>
            <option value="anuladas">Anuladas</option>
          </select>
        </div>
        <div class="filter-control">
          <label class="form-label" for="filtro-desde">Desde</label>
          <input id="filtro-desde" type="date" class="form-control" [(ngModel)]="filtroDesde" name="filtroDesde" />
        </div>
        <div class="filter-control">
          <label class="form-label" for="filtro-hasta">Hasta</label>
          <input id="filtro-hasta" type="date" class="form-control" [(ngModel)]="filtroHasta" name="filtroHasta" />
        </div>
      </div>
      <div class="filter-actions">
        <button type="submit" class="btn btn-primary d-inline-flex align-items-center gap-2">
          <i class="bi bi-search"></i>
          <span>Buscar</span>
        </button>
        <button
          type="button"
          class="btn btn-outline-light d-inline-flex align-items-center gap-2"
          (click)="limpiarFiltros()"
        >
          <i class="bi bi-arrow-counterclockwise"></i>
          <span>Reiniciar</span>
        </button>
      </div>
    </form>
  </div>

  <ng-template #registrandoVentaTpl>
    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
    <span>Guardando...</span>
  </ng-template>

  <div class="status-banner status-banner--info" *ngIf="estado === 'cargando'">
    <div class="spinner-border spinner-border-sm" role="status"></div>
    <span>Cargando ventas...</span>
  </div>

  <div class="status-banner status-banner--error" *ngIf="estado === 'error'">
    <i class="bi bi-wifi-off"></i>
    <div>
      <strong>Ups...</strong>
      <p class="mb-0">No pudimos cargar las ventas. Intenta nuevamente.</p>
    </div>
  </div>

  <div class="status-banner status-banner--muted" *ngIf="estado === 'listo' && !hayVentas">
    <i class="bi bi-inboxes"></i>
    <span>No hay ventas registradas todavía.</span>
  </div>

  <div class="surface-panel table-panel" *ngIf="estado === 'listo' && hayVentas">
    <div
      class="table-responsive ventas-table__wrapper"
      (scroll)="onTablaScroll($event)"
      [class.ventas-table__wrapper--scrolled]="tablaScrollActiva"
    >
      <table class="table ventas-table align-middle mb-0">
        <thead>
          <tr>
            <th class="text-center">ID</th>
            <th>Cliente</th>
            <th class="text-end">Total</th>
            <th>Tipo</th>
            <th>Estado</th>
            <th>Registrado por</th>
            <th>Fecha</th>
            <th class="text-end">Items</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let venta of ventas; let i = index">
            <tr>
              <td class="text-center">
                <span class="venta-id">{{ venta.ventaId }}</span>
              </td>
              <td>
                <div class="venta-client">
                  <p class="venta-client__name">{{ venta.clienteNombre }}</p>
                  <small class="venta-client__meta" *ngIf="!venta.activa && venta.motivoAnulacion">
                    Motivo: {{ venta.motivoAnulacion }}
                  </small>
                </div>
              </td>
              <td class="text-end">
                <span class="venta-amount">{{ venta.totalVenta | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
                <small class="text-muted d-block">
                  Ganancia: {{ calcularGananciaVenta(venta) | currency:'COP':'symbol-narrow':'1.0-0' }}
                </small>
              </td>
              <td>
                <span
                  class="venta-chip"
                  [ngClass]="venta.tipoVenta === 'CREDITO' ? 'venta-chip--warning' : 'venta-chip--info'"
                >
                  {{ venta.tipoVenta === 'CREDITO' ? 'Crédito' : 'Contado' }}
                </span>
              </td>
              <td>
                <span class="venta-chip" [ngClass]="venta.activa ? 'venta-chip--success' : 'venta-chip--muted'">
                  {{ venta.activa ? 'Activa' : 'Anulada' }}
                </span>
              </td>
              <td>
                <div class="venta-user">
                  <p class="venta-user__name">{{ venta.usuarioNombre }}</p>
                </div>
              </td>
              <td>
                <div class="venta-date">
                  <span>{{ venta.fechaRegistro | date:'mediumDate' }}</span>
                  <small class="text-muted">{{ venta.fechaRegistro | date:'shortTime' }}</small>
                </div>
              </td>
              <td class="text-end">
                <button
                  type="button"
                  class="venta-inline-btn"
                  [disabled]="!venta.items.length"
                  (click)="toggleItems(i)"
                >
                  <i class="bi bi-eye"></i>
                  <span>Ver items</span>
                  <span class="badge text-bg-primary-subtle text-primary-emphasis">{{ venta.items.length }}</span>
                </button>
              </td>
              <td class="text-end">
                <div class="venta-actions">
                  <button
                    type="button"
                    class="venta-action-btn"
                    (click)="descargarComprobante(venta)"
                    [disabled]="estaDescargandoComprobante(venta.ventaId)"
                    title="Descargar comprobante en PDF"
                  >
                    <ng-container *ngIf="!estaDescargandoComprobante(venta.ventaId); else descargandoTpl">
                      <i class="bi bi-file-earmark-pdf"></i>
                    </ng-container>
                  </button>
                  <button
                    type="button"
                    class="venta-action-btn venta-action-btn--danger"
                    *ngIf="venta.activa; else ventaAnulada"
                    (click)="anularVenta(venta)"
                    [disabled]="estaAnulandoVenta(venta.ventaId)"
                    title="Anular venta"
                  >
                    <ng-container *ngIf="!estaAnulandoVenta(venta.ventaId); else anulandoTpl">
                      <i class="bi bi-x-circle"></i>
                    </ng-container>
                  </button>
                </div>
                <ng-template #descargandoTpl>
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                  <span>Generando...</span>
                </ng-template>
                <ng-template #anulandoTpl>
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                  <span>Procesando...</span>
                </ng-template>
                <ng-template #ventaAnulada>
                  <span class="text-muted small">Sin acciones</span>
                </ng-template>
              </td>
            </tr>
            <tr *ngIf="esFilaExpandida(i)">
              <td colspan="8">
                <div class="venta-expand-panel">
                  <div class="venta-expand-panel__head">
                    <div>
                      <p class="venta-expand-panel__title">Items vendidos</p>
                      <small class="text-muted">Detalle por producto y ganancia estimada.</small>
                    </div>
                    <span class="badge text-bg-light text-primary">{{ venta.items.length }} items</span>
                  </div>
                  <div *ngIf="venta.items.length; else sinItems">
                    <div class="table-responsive">
                      <table class="table table-sm venta-items-table mb-0">
                        <thead>
                          <tr>
                            <th>Producto</th>
                            <th class="text-end">Precio compra unidad</th>
                            <th class="text-end">Cantidad</th>
                            <th class="text-end">Precio venta total</th>
                            <th class="text-end">Ganancia</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let item of venta.items">
                            <td class="text-uppercase">{{ item.productoNombre }}</td>
                            <td class="text-end">{{ item.precioCompra | currency:'COP':'symbol-narrow':'1.0-0' }}</td>
                            <td class="text-end">{{ item.cantidad }}</td>
                            <td class="text-end">{{ item.precioVenta | currency:'COP':'symbol-narrow':'1.0-0' }}</td>
                            <td class="text-end">
                              {{ calcularGananciaItem(item) | currency:'COP':'symbol-narrow':'1.0-0' }}
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <ng-template #sinItems>
                    <p class="text-muted mb-0">No hay items registrados para esta venta.</p>
                  </ng-template>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </div>

  <nav
    class="ventas-pagination"
    *ngIf="estado === 'listo' && mostrarPaginador"
    aria-label="Paginación de ventas"
  >
    <ul class="pagination pagination-sm mb-0">
      <li class="page-item" [class.disabled]="paginaActual === 0">
        <button class="page-link" type="button" (click)="cambiarPagina(paginaActual - 1)" [disabled]="paginaActual === 0">
          Anterior
        </button>
      </li>
      <li class="page-item" *ngFor="let pagina of paginas" [class.active]="pagina === paginaActual">
        <button class="page-link" type="button" (click)="cambiarPagina(pagina)">
          {{ pagina + 1 }}
        </button>
      </li>
      <li class="page-item" [class.disabled]="paginaActual === totalPaginas - 1">
        <button
          class="page-link"
          type="button"
          (click)="cambiarPagina(paginaActual + 1)"
          [disabled]="paginaActual === totalPaginas - 1"
        >
          Siguiente
        </button>
      </li>
    </ul>
  </nav>
</section>
