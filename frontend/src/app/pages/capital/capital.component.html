<section class="dashboard-shell">
  <div class="dashboard-hero glass-panel">
    <div class="hero-copy">
      <p class="hero-kicker text-uppercase">Panel general</p>
      <h1 class="hero-title">Resumen de capital</h1>
      <p class="hero-lede">Controla liquidez, cartera y ventas con la misma estética envolvente del resto de SICOIL.</p>
      <div class="hero-status">
        <div class="status-pill" *ngIf="estadoResumen === 'cargando'">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          <span>Actualizando resumen...</span>
        </div>
        <div class="status-pill status-pill--error" *ngIf="estadoResumen === 'error'">
          <i class="bi bi-exclamation-triangle"></i>
          <span>No se pudo cargar el resumen.</span>
        </div>
      </div>
    </div>
    <form class="hero-filters" novalidate>
      <div class="hero-filter">
        <label for="resumen-desde" class="form-label">Desde</label>
        <input
          type="date"
          id="resumen-desde"
          class="form-control"
          [(ngModel)]="filtroDesde"
          name="resumenDesde"
        />
      </div>
      <div class="hero-filter">
        <label for="resumen-hasta" class="form-label">Hasta</label>
        <input
          type="date"
          id="resumen-hasta"
          class="form-control"
          [(ngModel)]="filtroHasta"
          name="resumenHasta"
        />
      </div>
      <div class="hero-actions">
        <button type="button" class="btn btn-primary btn-sm" (click)="cargarResumen()">
          <i class="bi bi-search me-1"></i>
          Filtrar
        </button>
        <button type="button" class="btn btn-outline-light btn-sm" (click)="limpiarResumenFiltros()">
          <i class="bi bi-eraser me-1"></i>
          Limpiar
        </button>
      </div>
    </form>
  </div>

  <ng-container *ngIf="resumenListo; else resumenVacio">
    <div class="stat-grid">
      <article
        class="stat-card"
        matTooltip="Saldo disponible luego de restar todas las salidas de efectivo al capital actual."
      >
        <div class="stat-card__label">
          <span>Saldo real</span>
          <span class="badge text-bg-light text-primary">Actual</span>
        </div>
        <p class="stat-card__value" [ngClass]="montoColor(resumen?.saldoReal ?? 0)">
          {{ resumen?.saldoReal | currency:'COP':'symbol-narrow':'1.0-0' }}
        </p>
        <small>Liquidez disponible</small>
      </article>

      <article
        class="stat-card"
        matTooltip="Capital total de la empresa: activos menos pasivos registrados."
      >
        <div class="stat-card__label">
          <span>Capital neto</span>
        </div>
        <p class="stat-card__value" [ngClass]="montoColor(resumen?.capitalNeto ?? 0)">
          {{ resumen?.capitalNeto | currency:'COP':'symbol-narrow':'1.0-0' }}
        </p>
        <small>Activos - pasivos</small>
      </article>

      <article
        class="stat-card"
        matTooltip="Resultado del periodo: entradas menos salidas y costos asociados."
      >
        <div class="stat-card__label">
          <span>Ganancias</span>
        </div>
        <p class="stat-card__value" [ngClass]="montoColor(resumen?.totalGanancias ?? 0)">
          {{ resumen?.totalGanancias | currency:'COP':'symbol-narrow':'1.0-0' }}
        </p>
        <small>Resultado del periodo</small>
      </article>

      <div class="stat-grid-break" aria-hidden="true"></div>

      <article
        class="stat-card stat-card--compact"
        matTooltip="Cantidad total de unidades vendidas en el rango consultado."
      >
        <div class="stat-card__label">
          <span>Unidades vendidas</span>
        </div>
        <p class="stat-card__subvalue">{{ resumen?.totalUnidadesVendidas | number }}</p>
      </article>

      <article
        class="stat-card stat-card--compact"
        matTooltip="Equivalencia en cajas completas vendidas."
      >
        <div class="stat-card__label">
          <span>Cajas vendidas</span>
        </div>
        <p class="stat-card__subvalue">{{ resumen?.totalCajasVendidas | number:'1.0-2' }}</p>
      </article>
    </div>

    <div class="insight-grid">
      <article
        class="insight-card chart-card"
        matTooltip="Compara todo el efectivo entrante contra las salidas y crédito pendiente."
      >
        <div class="insight-card__head">
          <div>
            <p class="insight-kicker">Flujo de capital</p>
            <h3>Entradas vs salidas</h3>
          </div>
          <i class="bi bi-bar-chart-line"></i>
        </div>
        <ng-container *ngIf="comparativoFlujo.length; else sinDatosFlujo">
          <div class="chart-bar" *ngFor="let item of comparativoFlujo">
            <div class="chart-bar__meta">
              <span>{{ item.label }}</span>
              <span>{{ item.valor | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
            </div>
            <div class="chart-bar__track">
              <div
                class="chart-bar__fill"
                [ngClass]="{
                  'chart-bar__fill--success': item.clase === 'entradas',
                  'chart-bar__fill--danger': item.clase === 'salidas',
                  'chart-bar__fill--warning': item.clase === 'pendiente'
                }"
                [style.width.%]="maxFlujoValor ? (item.valor / maxFlujoValor) * 100 : 0"
              ></div>
            </div>
          </div>
        </ng-container>
        <ng-template #sinDatosFlujo>
          <p class="text-muted mb-0">No hay movimientos para graficar.</p>
        </ng-template>
      </article>

      <article
        class="insight-card chart-card"
        matTooltip="Muestra cuánto crédito se ha otorgado, lo recuperado y lo pendiente."
      >
        <div class="insight-card__head">
          <div>
            <p class="insight-kicker">Cartera</p>
            <h3>Crédito vs abonos</h3>
          </div>
          <i class="bi bi-graph-up-arrow"></i>
        </div>
        <ng-container *ngIf="creditoComparativo.length; else sinDatosCredito">
          <div class="chart-bar" *ngFor="let item of creditoComparativo">
            <div class="chart-bar__meta">
              <span>{{ item.label }}</span>
              <span>{{ item.valor | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
            </div>
            <div class="chart-bar__track">
              <div
                class="chart-bar__fill"
                [ngClass]="{
                  'chart-bar__fill--primary': item.clase === 'otorgado',
                  'chart-bar__fill--success': item.clase === 'abonos',
                  'chart-bar__fill--warning': item.clase === 'pendiente'
                }"
                [style.width.%]="maxCreditoValor ? (item.valor / maxCreditoValor) * 100 : 0"
              ></div>
            </div>
          </div>
        </ng-container>
        <ng-template #sinDatosCredito>
          <p class="text-muted mb-0">No hay créditos registrados.</p>
        </ng-template>
      </article>

      <article
        class="insight-card chart-card insight-card--gauge"
        matTooltip="Indicador visual del margen de ganancia respecto a las ventas del periodo."
      >
        <div class="insight-card__head">
          <div>
            <p class="insight-kicker">Rentabilidad</p>
            <h3>Margen del periodo</h3>
          </div>
          <i class="bi bi-speedometer2"></i>
        </div>
        <div class="gauge" [style.background]="rentabilidadGaugeBackground">
          <div class="gauge__inner" [ngClass]="rentabilidadEsPositiva ? 'text-success' : 'text-danger'">
            <span class="gauge__value">{{ rentabilidadPorcentaje | number:'1.0-1' }}%</span>
            <small class="text-muted d-block">sobre ventas</small>
          </div>
        </div>
        <p class="insight-foot">
          Ganancia acumulada:
          <strong>{{ resumen?.totalGanancias | currency:'COP':'symbol-narrow':'1.0-0' }}</strong>
        </p>
        <p class="insight-foot">
          Ventas totales:
          <strong>{{ resumen?.totalEntradas | currency:'COP':'symbol-narrow':'1.0-0' }}</strong>
        </p>
      </article>

      <article
        class="insight-card"
        matTooltip="Ranking de productos con mayor participación en ventas."
      >
        <div class="insight-card__head">
          <div>
            <p class="insight-kicker">Top productos</p>
            <h3>Participación por ventas</h3>
          </div>
          <i class="bi bi-trophy"></i>
        </div>
        <div *ngIf="productosDestacados.length > 0; else sinTopProductos" class="top-list">
          <div class="top-list__item" *ngFor="let producto of productosDestacados; trackBy: trackProducto">
            <div>
              <p class="top-list__title">{{ producto.productoNombre }}</p>
              <small class="text-muted">
                {{ producto.cantidadVendida }} uds · {{ producto.totalVendido | currency:'COP':'symbol-narrow':'1.0-0' }}
              </small>
            </div>
            <div class="top-list__value">
              {{ (producto.participacionPorcentaje / 100) | percent:'1.0-1' }}
            </div>
            <div class="top-product-bar">
              <div class="top-product-bar__fill" [style.width.%]="producto.participacionPorcentaje"></div>
            </div>
          </div>
        </div>
        <ng-template #sinTopProductos>
          <p class="text-muted mb-0">No hay productos destacados en el rango consultado.</p>
        </ng-template>
      </article>

      <article
        class="insight-card"
        matTooltip="Clientes con mayor aporte en las ventas del periodo."
      >
        <div class="insight-card__head">
          <div>
            <p class="insight-kicker">Top clientes</p>
            <h3>Participación por compras</h3>
          </div>
          <i class="bi bi-people"></i>
        </div>
        <div *ngIf="clientesDestacados.length > 0; else sinTopClientes" class="top-list">
          <div class="top-list__item" *ngFor="let cliente of clientesDestacados; trackBy: trackCliente">
            <div>
              <p class="top-list__title">{{ cliente.clienteNombre }}</p>
              <small class="text-muted">
                {{ cliente.totalVentas }} compras · {{ cliente.montoComprado | currency:'COP':'symbol-narrow':'1.0-0' }}
              </small>
            </div>
            <div class="top-list__value">
              {{ (cliente.participacionPorcentaje / 100) | percent:'1.0-1' }}
            </div>
            <div class="top-product-bar">
              <div class="top-product-bar__fill top-client__fill" [style.width.%]="cliente.participacionPorcentaje"></div>
            </div>
          </div>
        </div>
        <ng-template #sinTopClientes>
          <p class="text-muted mb-0">No hay clientes destacados en el rango consultado.</p>
        </ng-template>
      </article>
    </div>
  </ng-container>

  <ng-template #resumenVacio>
    <div class="status-banner status-banner--muted" *ngIf="estadoResumen === 'listo'">
      <i class="bi bi-info-circle"></i>
      <span>No hay información de resumen disponible para los filtros seleccionados.</span>
    </div>
  </ng-template>

  <section class="surface-panel filters-panel">
    <div class="filters-header">
      <div>
        <p class="filters-title">Movimientos</p>
        <p class="filters-subtitle mb-0">Refina la tabla con múltiples criterios y genera nuevas inyecciones.</p>
      </div>
      <button
        type="button"
        class="btn btn-success d-flex align-items-center gap-2"
        (click)="registrarInyeccion()"
        [disabled]="registrandoInyeccion"
      >
        <ng-container *ngIf="!registrandoInyeccion; else registrandoInyeccionTpl">
          <i class="bi bi-plus-circle"></i>
          <span>Nueva inyección</span>
        </ng-container>
      </button>
    </div>
    <div class="filters-grid">
      <div class="filters-field">
        <label for="filtro-origen">Origen</label>
        <select id="filtro-origen" class="form-select" [(ngModel)]="filtroOrigen">
          <option value="">Todos</option>
          <option value="VENTA">Venta</option>
          <option value="COMPRA">Compra</option>
          <option value="INYECCION">Inyección</option>
        </select>
      </div>
      <div class="filters-field">
        <label for="filtro-credito">Tipo</label>
        <select id="filtro-credito" class="form-select" [(ngModel)]="filtroCredito">
          <option value="">Todos</option>
          <option value="false">Contado</option>
          <option value="true">Crédito</option>
        </select>
      </div>
      <div class="filters-field">
        <label for="filtro-desc">Descripción</label>
        <input
          type="text"
          id="filtro-desc"
          class="form-control"
          placeholder="Texto incluido"
          [(ngModel)]="filtroDescripcion"
          (keyup.enter)="buscar()"
        />
      </div>
      <div class="filters-field">
        <label for="filtro-desde">Desde</label>
        <input type="date" id="filtro-desde" class="form-control" [(ngModel)]="filtroDesde" />
      </div>
      <div class="filters-field">
        <label for="filtro-hasta">Hasta</label>
        <input type="date" id="filtro-hasta" class="form-control" [(ngModel)]="filtroHasta" />
      </div>
    </div>
    <div class="filters-actions">
      <button type="button" class="btn btn-primary" (click)="buscar()">
        <i class="bi bi-search me-1"></i>
        Buscar
      </button>
      <button type="button" class="btn btn-outline-secondary" (click)="limpiarFiltros()">
        <i class="bi bi-eraser me-1"></i>
        Limpiar
      </button>
    </div>
  </section>

  <ng-template #registrandoInyeccionTpl>
    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
    <span>Guardando...</span>
  </ng-template>

  <div class="status-banner status-banner--info" *ngIf="estadoMovimientos === 'cargando'">
    <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
    <span>Cargando movimientos...</span>
  </div>

  <div class="status-banner status-banner--error" *ngIf="estadoMovimientos === 'error'">
    <i class="bi bi-wifi-off"></i>
    <div>
      <strong>Ups...</strong>
      <p class="mb-0">No pudimos cargar los movimientos. Intenta nuevamente.</p>
    </div>
  </div>

  <div class="status-banner status-banner--muted" *ngIf="estadoMovimientos === 'listo' && !hayMovimientos">
    <i class="bi bi-inboxes"></i>
    <span>No hay movimientos registrados con los filtros aplicados.</span>
  </div>

  <div class="surface-panel table-panel" *ngIf="estadoMovimientos === 'listo' && hayMovimientos">
    <div
      class="table-responsive dashboard-table__wrapper"
      (scroll)="onTablaScroll($event)"
      [class.dashboard-table__wrapper--scrolled]="tablaScrollActiva"
    >
      <table class="table dashboard-table align-middle mb-0">
        <thead>
          <tr>
            <th>Origen</th>
            <th>Descripción</th>
            <th class="text-end">Monto</th>
            <th>Tipo</th>
            <th>Registrado por</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let movimiento of movimientos">
            <td>
              <span class="badge origin-pill text-uppercase">{{ origenLegible(movimiento.origen) }}</span>
            </td>
            <td>
              <div class="fw-semibold mb-0">{{ movimiento.descripcion || 'Sin descripción' }}</div>
            </td>
            <td class="text-end">
              <div class="fw-semibold" [ngClass]="montoClase(movimiento.origen)">
                {{ movimiento.monto | currency:'COP':'symbol-narrow':'1.0-0' }}
              </div>
            </td>
            <td>
              <span class="badge" [ngClass]="movimiento.esCredito ? 'text-bg-warning' : 'text-bg-success'">
                {{ movimiento.esCredito ? 'Crédito' : 'Contado' }}
              </span>
            </td>
            <td>
              <div class="fw-semibold">{{ movimiento.usuarioNombre }}</div>
              <div class="text-muted small">ID: {{ movimiento.usuarioId }}</div>
            </td>
            <td>
              <div>{{ movimiento.creadoEn | date:'shortDate' }}</div>
              <small class="text-muted">{{ movimiento.creadoEn | date:'shortTime' }}</small>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <nav
    class="dashboard-pagination"
    *ngIf="estadoMovimientos === 'listo' && mostrarPaginador"
    aria-label="Paginación de movimientos"
  >
    <ul class="pagination pagination-sm mb-0">
      <li class="page-item" [class.disabled]="paginaActual === 0">
        <button class="page-link" type="button" (click)="cambiarPagina(paginaActual - 1)" [disabled]="paginaActual === 0">
          Anterior
        </button>
      </li>
      <li
        class="page-item"
        *ngFor="let pagina of paginas"
        [class.active]="pagina === paginaActual"
      >
        <button class="page-link" type="button" (click)="cambiarPagina(pagina)">
          {{ pagina + 1 }}
        </button>
      </li>
      <li class="page-item" [class.disabled]="paginaActual === totalPaginas - 1">
        <button
          class="page-link"
          type="button"
          (click)="cambiarPagina(paginaActual + 1)"
          [disabled]="paginaActual === totalPaginas - 1"
        >
          Siguiente
        </button>
      </li>
    </ul>
  </nav>
</section>
