<section class="inventory-shell">
  <div class="inventory-hero glass-panel">
    <div class="hero-copy">
      <p class="hero-kicker text-uppercase">Inventario</p>
      <h1 class="hero-title">Catálogo de productos</h1>
      <p class="hero-lede">Monitorea ingresos, lotes y stock en un panel integrado con el resto de SICOIL.</p>
      <div class="hero-metrics">
        <div class="metric-chip">
          <span>En esta vista</span>
          <strong>{{ productos.length }}</strong>
        </div>
        <div class="metric-chip">
          <span>Total registrados</span>
          <strong>{{ totalElementos }}</strong>
        </div>
      </div>
      <div class="hero-actions">
        <button
          type="button"
          class="btn btn-outline-light d-flex align-items-center gap-2"
          (click)="registrarProducto()"
          [disabled]="creandoProducto"
        >
          <ng-container *ngIf="!creandoProducto; else creandoProductoTpl">
            <i class="bi bi-box-seam"></i>
            <span>Nuevo producto</span>
          </ng-container>
        </button>
        <button
          type="button"
          class="btn btn-primary d-flex align-items-center gap-2"
          (click)="agregarIngreso()"
          [disabled]="registrandoIngreso"
        >
          <ng-container *ngIf="!registrandoIngreso; else guardandoIngreso">
            <i class="bi bi-plus-circle"></i>
            <span>Agregar ingreso</span>
          </ng-container>
        </button>
      </div>
    </div>

    <form class="inventory-search" novalidate (ngSubmit)="buscarProductos()">
      <label for="input-busqueda-producto" class="form-label">Buscar producto</label>
      <div class="search-control">
        <input
          type="text"
          id="input-busqueda-producto"
          class="form-control"
          placeholder="Nombre del producto o referencia"
          [(ngModel)]="terminoBusqueda"
          name="terminoBusqueda"
        />
        <div class="search-actions">
          <button class="btn btn-primary" type="submit">
            <i class="bi bi-search me-1"></i>
            Buscar
          </button>
          <button class="btn btn-outline-light" type="button" (click)="reiniciarBusqueda()">
            <i class="bi bi-arrow-counterclockwise me-1"></i>
            Reiniciar
          </button>
        </div>
      </div>
    </form>
  </div>

  <ng-template #creandoProductoTpl>
    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
    <span>Guardando...</span>
  </ng-template>
  <ng-template #guardandoIngreso>
    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
    <span>Guardando...</span>
  </ng-template>

  <div class="status-banner status-banner--info" *ngIf="estado === 'cargando'">
    <div class="spinner-border spinner-border-sm" role="status"></div>
    <span>Cargando productos...</span>
  </div>

  <div class="status-banner status-banner--error" *ngIf="estado === 'error'">
    <i class="bi bi-wifi-off"></i>
    <div>
      <strong>Ups...</strong>
      <p class="mb-0">No pudimos cargar los productos. Intenta nuevamente.</p>
    </div>
  </div>

  <div class="status-banner status-banner--muted" *ngIf="estado === 'listo' && !hayProductos">
    <i class="bi bi-inboxes"></i>
    <span>No hay productos registrados todavía.</span>
  </div>

  <div class="surface-panel table-panel" *ngIf="estado === 'listo' && hayProductos">
    <div
      class="table-responsive inventory-table__wrapper"
      (scroll)="onTablaScroll($event)"
      [class.inventory-table__wrapper--scrolled]="tablaScrollActiva"
    >
      <table class="table inventory-table align-middle mb-0">
        <thead>
          <tr>
            <th>Producto</th>
            <th class="text-end">Stock total</th>
            <th class="text-end">Capacidad (cajas)</th>
            <th class="text-end">Lotes</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let producto of productos; let i = index">
            <tr>
              <td>
                <div class="inventory-product">
                  <p class="inventory-product__name">{{ producto.nombre }}</p>
                </div>
              </td>
              <td class="text-end">
                <span class="inventory-value">{{ producto.stockTotal }}</span>
              </td>
              <td class="text-end">
                <span class="inventory-value">{{ producto.cantidadPorCajas }}</span>
              </td>
              <td class="text-end">
                <button
                  type="button"
                  class="btn btn-outline-primary btn-sm d-inline-flex align-items-center gap-2"
                  [disabled]="!producto.variantes.length"
                  (click)="toggleVariantes(i)"
                >
                  <i class="bi bi-eye"></i>
                  <span>Lotes</span>
                  <span class="badge text-bg-primary-subtle text-primary-emphasis">{{ producto.variantes.length }}</span>
                </button>
              </td>
              <td class="text-end">
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center gap-2"
                  (click)="editarProducto(producto)"
                  [disabled]="estaProductoProcesando(producto.nombre)"
                >
                  <ng-container *ngIf="!estaProductoProcesando(producto.nombre); else editandoProducto">
                    <i class="bi bi-pencil"></i>
                    <span>Editar</span>
                  </ng-container>
                </button>
                <ng-template #editandoProducto>
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                  <span>Guardando...</span>
                </ng-template>
              </td>
            </tr>
            <tr *ngIf="esFilaExpandida(i)">
              <td colspan="5">
                <div class="variant-panel">
                  <div class="variant-panel__head">
                    <div>
                      <p class="variant-panel__title">Lotes registrados</p>
                      <small class="text-muted">Gestiona precios y stock específicos por cada lote.</small>
                    </div>
                    <span class="variant-count badge text-bg-light text-primary">
                      {{ producto.variantes.length }} en total
                    </span>
                  </div>
                  <div *ngIf="producto.variantes.length; else sinLotes">
                    <div class="table-responsive">
                      <table class="table table-sm variant-table mb-0">
                        <thead>
                          <tr>
                            <th>Precio unidad</th>
                            <th>Precio por caja</th>
                            <th>Stock</th>
                            <th>Comentario</th>
                            <th class="text-end">Acciones</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let variante of producto.variantes">
                            <td>$ {{ variante.precioCompra | number:'1.0-0' }}</td>
                            <td>$ {{ (variante.precioCompra * producto.cantidadPorCajas) | number:'1.0-0' }}</td>
                            <td>{{ variante.stock }}</td>
                            <td>{{ variante.comentario || '—' }}</td>
                            <td class="text-end">
                              <button
                                type="button"
                                class="btn btn-outline-danger btn-sm"
                                title="Eliminar stock"
                                (click)="eliminarCantidadVariante(producto, variante)"
                                [disabled]="variante.stock === 0 || estaVarianteProcesando(variante.id)"
                              >
                                <ng-container *ngIf="!estaVarianteProcesando(variante.id); else eliminandoVariante">
                                  <i class="bi bi-box-arrow-down"></i>
                                </ng-container>
                              </button>
                              <ng-template #eliminandoVariante>
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                              </ng-template>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <ng-template #sinLotes>
                    <p class="text-muted mb-0">No hay lotes con stock disponible para este producto.</p>
                  </ng-template>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </div>

  <nav
    class="inventory-pagination"
    *ngIf="estado === 'listo' && mostrarPaginador"
    aria-label="Paginación de productos"
  >
    <ul class="pagination pagination-sm mb-0">
      <li class="page-item" [class.disabled]="paginaActual === 0">
        <button class="page-link" type="button" (click)="cambiarPagina(paginaActual - 1)" [disabled]="paginaActual === 0">
          Anterior
        </button>
      </li>
      <li
        class="page-item"
        *ngFor="let pagina of paginas"
        [class.active]="pagina === paginaActual"
      >
        <button
          class="page-link"
          type="button"
          (click)="cambiarPagina(pagina)"
        >
          {{ pagina + 1 }}
        </button>
      </li>
      <li class="page-item" [class.disabled]="paginaActual === totalPaginas - 1">
        <button
          class="page-link"
          type="button"
          (click)="cambiarPagina(paginaActual + 1)"
          [disabled]="paginaActual === totalPaginas - 1"
        >
          Siguiente
        </button>
      </li>
    </ul>
  </nav>
</section>
