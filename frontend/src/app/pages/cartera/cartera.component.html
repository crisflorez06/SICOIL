<section class="cartera-shell">
  <div class="cartera-hero glass-panel">
    <div class="hero-copy">
      <p class="hero-kicker text-uppercase">Cartera</p>
      <h1 class="hero-title">Seguimiento de créditos y abonos</h1>
      <p class="hero-lede">
        Consulta saldos pendientes, revisa los movimientos y registra abonos con la misma experiencia visual del resto
        de SICOIL.
      </p>
      <div class="hero-metrics">
        <div class="metric-chip">
          <span>Cuentas con saldo</span>
          <strong>{{ totalClientesConSaldo }}</strong>
        </div>
        <div class="metric-chip">
          <span>Saldo pendiente</span>
          <strong>{{ saldoPendienteTotal | currency:'COP':'symbol-narrow':'1.0-0' }}</strong>
        </div>
        <div class="metric-chip">
          <span>Total abonos</span>
          <strong>{{ totalAbonosAcumulados | currency:'COP':'symbol-narrow':'1.0-0' }}</strong>
        </div>
        <div class="metric-chip">
          <span>Créditos registrados</span>
          <strong>{{ totalCreditosAcumulados | currency:'COP':'symbol-narrow':'1.0-0' }}</strong>
        </div>
      </div>
    </div>

    <form class="cartera-filters" novalidate (ngSubmit)="buscarCartera()">
      <p class="form-label">Filtros activos</p>
      <div class="filter-grid">
        <div class="filter-control">
          <label class="form-label" for="filtro-cliente">Cliente</label>
          <input
            type="text"
            id="filtro-cliente"
            class="form-control"
            placeholder="Nombre del cliente"
            [(ngModel)]="filtroCliente"
            name="filtroCliente"
          />
        </div>

        <div class="filter-control">
          <label class="form-label" for="filtro-desde">Desde</label>
          <input type="date" id="filtro-desde" class="form-control" [(ngModel)]="filtroDesde" name="filtroDesde" />
        </div>

        <div class="filter-control">
          <label class="form-label" for="filtro-hasta">Hasta</label>
          <input type="date" id="filtro-hasta" class="form-control" [(ngModel)]="filtroHasta" name="filtroHasta" />
        </div>
      </div>
      <div class="filter-actions">
        <button type="submit" class="btn btn-primary d-inline-flex align-items-center gap-2">
          <i class="bi bi-search"></i>
          <span>Buscar</span>
        </button>
        <button
          type="button"
          class="btn btn-outline-light d-inline-flex align-items-center gap-2"
          (click)="limpiarFiltros()"
        >
          <i class="bi bi-arrow-counterclockwise"></i>
          <span>Reiniciar</span>
        </button>
      </div>
    </form>
  </div>

  <div class="status-banner status-banner--info" *ngIf="estado === 'cargando'">
    <div class="spinner-border spinner-border-sm" role="status"></div>
    <span>Cargando cartera...</span>
  </div>

  <div class="status-banner status-banner--error" *ngIf="estado === 'error'">
    <i class="bi bi-wifi-off"></i>
    <div>
      <strong>Ups...</strong>
      <p class="mb-0">No pudimos cargar la cartera. Intenta nuevamente.</p>
    </div>
  </div>

  <div class="status-banner status-banner--muted" *ngIf="estado === 'listo' && !hayClientesConSaldo">
    <i class="bi bi-inboxes"></i>
    <span>No hay clientes con saldo pendiente.</span>
  </div>

  <div class="surface-panel table-panel" *ngIf="estado === 'listo' && hayClientesConSaldo">
    <div class="table-responsive cartera-table__wrapper">
      <table class="table cartera-table align-middle mb-0">
        <thead>
          <tr>
            <th>Cliente</th>
            <th class="text-end">Saldo pendiente</th>
            <th class="text-end">Total abonos</th>
            <th class="text-end">Total créditos</th>
            <th>Última actualización</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let cliente of cartera">
            <tr>
              <td>
                <div class="cartera-client">
                  <p class="cartera-client__name">{{ cliente.clienteNombre }}</p>
                </div>
              </td>
              <td class="text-end">
                <span class="cartera-amount cartera-amount--pending">{{
                  cliente.saldoPendiente | currency:'COP':'symbol-narrow':'1.0-0'
                }}</span>
              </td>
              <td class="text-end">
                <div class="cartera-cell">
                  <span class="cartera-amount">{{ cliente.totalAbonos | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
                  <button type="button" class="cartera-inline-btn" (click)="verAbonos(cliente)">
                    <i class="bi bi-eye"></i>
                    <span>Ver</span>
                  </button>
                </div>
              </td>
              <td class="text-end">
                <div class="cartera-cell">
                  <span class="cartera-amount">{{ cliente.totalCreditos | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
                  <button
                    type="button"
                    class="cartera-inline-btn"
                    (click)="verCreditos(cliente)"
                    [disabled]="cliente.totalCreditos === 0"
                  >
                    <i class="bi bi-eye"></i>
                    <span>Ver</span>
                  </button>
                </div>
              </td>
              <td>
                <div class="cartera-date">
                  <span>{{ cliente.ultimaActualizacion | date:'dd/MM/yyyy' }}</span>
                  <small class="text-muted">{{ cliente.ultimaActualizacion | date:'shortTime' }}</small>
                </div>
              </td>
              <td class="text-end">
                <button
                  type="button"
                  class="cartera-action-btn"
                  (click)="registrarAbono(cliente)"
                  [disabled]="estaRegistrandoAbono(cliente.clienteId)"
                >
                  <ng-container *ngIf="!estaRegistrandoAbono(cliente.clienteId); else registrandoAbonoTpl">
                    <i class="bi bi-piggy-bank"></i>
                    <span>Registrar abono</span>
                  </ng-container>
                </button>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </div>
</section>

<ng-template #registrandoAbonoTpl>
  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
  <span>Guardando...</span>
</ng-template>
