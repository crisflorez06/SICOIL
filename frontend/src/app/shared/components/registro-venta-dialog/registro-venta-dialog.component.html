<section class="inventory-dialog registro-venta-dialog">
  <header class="dialog-header">
    <div class="dialog-icon">
      <i class="bi bi-cash-stack"></i>
    </div>
    <div class="dialog-headings">
      <h2 mat-dialog-title class="dialog-title">Registrar venta</h2>
      <p class="dialog-subtitle">Completa los datos y agrega los productos vendidos a la lista.</p>
    </div>
    <div class="dialog-total">
      <span>Total estimado</span>
      <strong>{{ totalCalculado | currency:'COP':'symbol-narrow':'1.0-0' }}</strong>
    </div>
  </header>

  <div mat-dialog-content class="dialog-content">
    <ng-container *ngIf="!cargandoFiltros && !errorFiltros; else estadoFiltros">
      <form [formGroup]="formulario" class="dialog-body">
        <section class="dialog-section">
          <div class="dialog-section__head">
            <div>
              <p class="section-kicker">Datos del cliente</p>
              <p class="section-subtitle">Selecciona al cliente y el tipo de venta.</p>
            </div>
            <mat-button-toggle-group formControlName="tipoVenta" appearance="legacy" class="modo-venta-toggle">
              <mat-button-toggle value="CONTADO">Contado</mat-button-toggle>
              <mat-button-toggle value="CREDITO">Crédito</mat-button-toggle>
            </mat-button-toggle-group>
          </div>

          <div class="dialog-grid">
            <mat-form-field appearance="outline">
              <mat-label>Cliente</mat-label>
              <input
                matInput
                type="text"
                placeholder="Selecciona un cliente"
                formControlName="clienteNombre"
                [matAutocomplete]="clienteAuto"
                autocomplete="off"
              />
              <mat-error *ngIf="formulario.get('clienteNombre')?.hasError('required')">
                Debes ingresar el nombre del cliente.
              </mat-error>
              <mat-error *ngIf="clienteNombreInvalido">Selecciona un cliente existente.</mat-error>
              <mat-autocomplete
                #clienteAuto="matAutocomplete"
                autoActiveFirstOption
                (optionSelected)="seleccionarCliente($event.option.value)"
              >
                <mat-option *ngFor="let cliente of clientesFiltrados" [value]="cliente.nombre">
                  {{ cliente.nombre }}
                </mat-option>
                <mat-option *ngIf="clientesFiltrados.length === 0" disabled>Sin coincidencias</mat-option>
              </mat-autocomplete>
            </mat-form-field>
          </div>
        </section>

        <section class="dialog-section" [formGroup]="itemForm">
          <div class="dialog-section__head">
            <div>
              <p class="section-kicker">Detalle de productos</p>
              <p class="section-subtitle">Selecciona el producto, registra el subtotal y la cantidad vendida.</p>
            </div>
          </div>

          <div class="venta-form-row">
            <mat-form-field appearance="outline" class="venta-form-row__producto">
              <mat-label>Producto</mat-label>
              <input
                matInput
                type="text"
                formControlName="productoNombre"
                [matAutocomplete]="productoAuto"
                autocomplete="off"
                [disabled]="productosDisponibles.length === 0"
                class="text-uppercase"
              />
              <mat-error *ngIf="itemForm.get('productoNombre')?.hasError('required')">Selecciona un producto.</mat-error>
              <mat-error *ngIf="productoNombreInvalido">Selecciona un producto existente.</mat-error>
              <mat-autocomplete
                #productoAuto="matAutocomplete"
                autoActiveFirstOption
                (optionSelected)="seleccionarProducto($event.option.value)"
              >
                <mat-option
                  *ngFor="let producto of productosFiltrados"
                  [value]="producto.nombreProducto"
                  class="text-uppercase"
                >
                  {{ producto.nombreProducto }}
                </mat-option>
                <mat-option *ngIf="productosFiltrados.length === 0" disabled>Sin coincidencias</mat-option>
              </mat-autocomplete>
            </mat-form-field>

            <mat-form-field appearance="outline" class="venta-form-row__total">
              <mat-label>Total por unidad</mat-label>
              <input matInput type="number" formControlName="precioVenta" />
              <mat-error *ngIf="itemForm.get('precioVenta')?.hasError('required')">Ingresar un precio.</mat-error>
              <mat-error *ngIf="itemForm.get('precioVenta')?.hasError('min')">Debe ser mayor a 0.</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="venta-form-row__cantidad">
              <mat-label>Cantidad</mat-label>
              <input matInput type="number" min="1" formControlName="cantidad" />
              <mat-error *ngIf="itemForm.get('cantidad')?.hasError('required')">Requerido.</mat-error>
              <mat-error *ngIf="itemForm.get('cantidad')?.hasError('min')">Debe ser al menos 1.</mat-error>
              <mat-error *ngIf="itemForm.get('cantidad')?.hasError('stockInsuficiente')">
                Stock insuficiente para este producto.
              </mat-error>
            </mat-form-field>
          </div>

          <div class="dialog-section__actions">
            <button
              type="button"
              class="dialog-btn dialog-btn--ghost dialog-btn--compact"
              (click)="agregarItemALista()"
              [disabled]="productosDisponibles.length === 0"
            >
              <i class="bi bi-plus-circle"></i>
              <span>Agregar a la lista</span>
            </button>
          </div>
        </section>

        <section class="dialog-section dialog-section--surface">
          <div class="dialog-section__head">
            <div>
              <p class="section-kicker">Productos agregados</p>
              <p class="section-subtitle">Revisa la lista antes de registrar la venta.</p>
            </div>
          </div>
          <ng-container *ngIf="itemsRegistrados.length > 0; else listaVacia">
            <div class="table-responsive">
              <table class="table table-sm venta-items-table mb-0">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th class="text-end">Precio venta</th>
                    <th class="text-end">Cantidad</th>
                    <th class="text-end">Subtotal</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of itemsRegistrados; let i = index">
                    <td>
                      <div class="venta-item__name">{{ item.productoNombre }}</div>
                    </td>
                    <td class="text-end">{{ item.precioVenta | currency:'COP':'symbol-narrow':'1.0-0' }}</td>
                    <td class="text-end">{{ item.cantidad }}</td>
                    <td class="text-end">{{ item.subtotal | currency:'COP':'symbol-narrow':'1.0-0' }}</td>
                    <td class="text-end">
                      <button type="button" class="icon-button icon-button--danger" (click)="eliminarItem(i)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </ng-container>
          <ng-template #listaVacia>
            <p class="text-muted fst-italic mb-0">Aún no has agregado productos.</p>
          </ng-template>
        </section>
      </form>
    </ng-container>
  </div>

  <ng-template #estadoFiltros>
    <div class="estado-panel" *ngIf="cargandoFiltros">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <p class="text-muted mb-0">Cargando opciones para registrar la venta...</p>
    </div>
    <div class="estado-panel estado-panel--error" *ngIf="!cargandoFiltros && errorFiltros">
      <p class="text-muted mb-2">No pudimos cargar los filtros necesarios.</p>
      <button type="button" class="dialog-btn dialog-btn--ghost dialog-btn--compact" (click)="reintentarFiltros()">
        Reintentar
      </button>
    </div>
  </ng-template>

  <div mat-dialog-actions class="dialog-actions">
    <button type="button" class="dialog-btn dialog-btn--ghost" (click)="cancelar()">Cancelar</button>
    <button
      type="button"
      class="dialog-btn dialog-btn--primary"
      (click)="guardar()"
      [disabled]="cargandoFiltros || errorFiltros || itemsRegistrados.length === 0"
    >
      Registrar
    </button>
  </div>
</section>
