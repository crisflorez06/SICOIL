<h2 mat-dialog-title class="dialog-title">
  <div>
    <span class="h5 mb-1 d-block">Registrar venta</span>
    <p class="text-muted small mb-0">Completa los datos y agrega los productos vendidos a la lista.</p>
  </div>
  <div class="resumen-total text-end">
    <span class="resumen-total__label">Total estimado</span>
    <span class="resumen-total__valor">{{ totalCalculado | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
  </div>
</h2>
<div mat-dialog-content>
  <ng-container *ngIf="!cargandoFiltros && !errorFiltros; else estadoFiltros">
    <form [formGroup]="formulario" class="d-flex flex-column gap-4">
      <section class="border rounded p-3 bg-light-subtle d-flex flex-column gap-3">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
          <div>
            <span class="fw-semibold text-uppercase small text-muted d-block">Datos del cliente</span>
            <p class="text-muted small mb-0">Selecciona al cliente y el tipo de venta.</p>
          </div>
          <mat-button-toggle-group formControlName="tipoVenta" appearance="legacy" class="modo-venta-group">
            <mat-button-toggle value="CONTADO">Contado</mat-button-toggle>
            <mat-button-toggle value="CREDITO">Crédito</mat-button-toggle>
          </mat-button-toggle-group>
        </div>
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Cliente</mat-label>
              <input
                matInput
                type="text"
                placeholder="Selecciona un cliente"
                formControlName="clienteNombre"
                [matAutocomplete]="clienteAuto"
                autocomplete="off"
              />
              <mat-error *ngIf="formulario.get('clienteNombre')?.hasError('required')">
                Debes ingresar el nombre del cliente.
              </mat-error>
              <mat-error *ngIf="clienteNombreInvalido">Selecciona un cliente existente.</mat-error>
              <mat-autocomplete
                #clienteAuto="matAutocomplete"
                autoActiveFirstOption
                (optionSelected)="seleccionarCliente($event.option.value)"
              >
                <mat-option *ngFor="let cliente of clientesFiltrados" [value]="cliente.nombre">
                  {{ cliente.nombre }}
                </mat-option>
                <mat-option *ngIf="clientesFiltrados.length === 0" disabled>
                  Sin coincidencias
                </mat-option>
              </mat-autocomplete>
            </mat-form-field>
          </div>
        </div>
      </section>

      <section class="border rounded p-3 bg-light-subtle d-flex flex-column gap-3" [formGroup]="itemForm">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
          <div>
            <span class="fw-semibold text-uppercase small text-muted d-block">Detalle de productos</span>
            <p class="text-muted small mb-0">Selecciona el producto, su precio disponible y la cantidad vendida.</p>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-md-4">
            <div class="d-flex flex-column gap-3">
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>Producto</mat-label>
                <input
                  matInput
                  type="text"
                  formControlName="productoNombre"
                  [matAutocomplete]="productoAuto"
                  autocomplete="off"
                  [disabled]="productosDisponibles.length === 0"
                  class="text-uppercase"
                />
                <mat-error *ngIf="itemForm.get('productoNombre')?.hasError('required')">
                  Selecciona un producto.
                </mat-error>
                <mat-error *ngIf="productoNombreInvalido">Selecciona un producto existente.</mat-error>
                <mat-autocomplete
                  #productoAuto="matAutocomplete"
                  autoActiveFirstOption
                  (optionSelected)="seleccionarProducto($event.option.value)"
                >
                  <mat-option *ngFor="let producto of productosFiltrados" [value]="producto.nombreProducto" class="text-uppercase">
                    {{ producto.nombreProducto }}
                  </mat-option>
                  <mat-option *ngIf="productosFiltrados.length === 0" disabled>
                    Sin coincidencias
                  </mat-option>
                </mat-autocomplete>
              </mat-form-field>
              <mat-form-field appearance="outline" class="w-100 mb-0">
                <mat-label>Precio de venta</mat-label>
                <input matInput type="number" formControlName="precioVenta" />
                <mat-error *ngIf="itemForm.get('precioVenta')?.hasError('required')">
                  Ingresar un precio.
                </mat-error>
                <mat-error *ngIf="itemForm.get('precioVenta')?.hasError('min')">
                  Debe ser mayor a 0.
                </mat-error>
              </mat-form-field>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Precio disponible</mat-label>
              <mat-select
                formControlName="precioId"
                (selectionChange)="cambioPrecio()"
                [disabled]="!itemForm.get('productoNombre')?.value"
              >
                <ng-container *ngIf="preciosDisponiblesActuales as preciosDisponibles">
                  <mat-option *ngFor="let precio of preciosDisponibles" [value]="precio.id">
                    {{ precio.precioCompra | currency:'COP':'symbol-narrow':'1.0-0' }}
                  </mat-option>
                  <mat-option
                    *ngIf="itemForm.get('productoNombre')?.value && preciosDisponibles.length === 0"
                    disabled
                  >
                    Este producto no tiene stock disponible.
                  </mat-option>
                </ng-container>
              </mat-select>
              <mat-error *ngIf="itemForm.get('precioId')?.hasError('required')">
                Selecciona un precio.
              </mat-error>
            </mat-form-field>
          </div>
          <div class="col-12 col-md-4">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Cantidad</mat-label>
              <input matInput type="number" min="1" formControlName="cantidad" />
              <mat-error *ngIf="itemForm.get('cantidad')?.hasError('required')">
                Requerido.
              </mat-error>
              <mat-error *ngIf="itemForm.get('cantidad')?.hasError('min')">
                Debe ser al menos 1.
              </mat-error>
              <mat-error *ngIf="itemForm.get('cantidad')?.hasError('stockInsuficiente')">
                Stock insuficiente para este producto.
              </mat-error>
            </mat-form-field>
          </div>
        </div>

        <div class="d-flex justify-content-end">
          <button
            mat-stroked-button
            color="primary"
            type="button"
            (click)="agregarItemALista()"
            [disabled]="productosDisponibles.length === 0"
          >
            <i class="bi bi-plus-circle me-2"></i>
            Agregar a la lista
          </button>
        </div>
      </section>

      <section class="border rounded p-3 bg-white shadow-sm">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
          <div>
            <span class="fw-semibold text-uppercase small text-muted d-block">Productos agregados</span>
            <p class="text-muted small mb-0">Revisa la lista antes de registrar la venta.</p>
          </div>
        </div>
        <ng-container *ngIf="itemsRegistrados.length > 0; else listaVacia">
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0">
              <thead class="table-light text-uppercase text-muted small">
                <tr>
                  <th>Producto</th>
                  <th class="text-end">Precio compra</th>
                  <th class="text-end">Precio venta</th>
                  <th class="text-end">Cantidad</th>
                  <th class="text-end">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of itemsRegistrados; let i = index">
                  <td>
                    <div class="fw-semibold text-uppercase">{{ item.productoNombre }}</div>
                  </td>
                  <td class="text-end">{{ item.costoUnitario | currency:'COP':'symbol-narrow':'1.0-0' }}</td>
                  <td class="text-end">{{ item.precioVenta | currency:'COP':'symbol-narrow':'1.0-0' }}</td>
                  <td class="text-end">{{ item.cantidad }}</td>
                  <td class="text-end">
                    <button mat-icon-button color="warn" type="button" (click)="eliminarItem(i)" aria-label="Eliminar">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </ng-container>
        <ng-template #listaVacia>
          <p class="text-muted fst-italic mb-0">Aún no has agregado productos.</p>
        </ng-template>
      </section>
    </form>
  </ng-container>
</div>

<ng-template #estadoFiltros>
  <div class="estado-filtros" *ngIf="cargandoFiltros">
    <div class="spinner-border" role="status" aria-hidden="true"></div>
    <p class="text-muted mb-0">Cargando opciones para registrar la venta...</p>
  </div>
  <div class="estado-filtros" *ngIf="!cargandoFiltros && errorFiltros">
    <p class="text-muted mb-2">No pudimos cargar los filtros necesarios.</p>
    <button mat-stroked-button color="primary" type="button" (click)="reintentarFiltros()">
      Reintentar
    </button>
  </div>
</ng-template>

<div mat-dialog-actions class="d-flex justify-content-end gap-2 mt-3">
  <button mat-button type="button" (click)="cancelar()">Cancelar</button>
  <button
    mat-flat-button
    color="primary"
    type="button"
    (click)="guardar()"
    [disabled]="cargandoFiltros || errorFiltros || itemsRegistrados.length === 0"
  >
    Registrar
  </button>
</div>
