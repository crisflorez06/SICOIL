<h2 mat-dialog-title class="h5 mb-2">Registrar ingreso</h2>
<div mat-dialog-content>
  <form [formGroup]="formulario" class="d-flex flex-column gap-4">
    <div class="d-flex flex-column gap-2 border rounded p-3 bg-light-subtle">
      <div class="d-flex flex-column flex-md-row gap-2">
        <mat-form-field appearance="outline" class="flex-fill">
          <mat-label>Nombre del producto</mat-label>
          <input
            matInput
            placeholder="Ej. Aceite Premium"
            formControlName="nombreProducto"
            [matAutocomplete]="productoAuto"
            autocomplete="off"
          />
          <mat-error *ngIf="formulario.get('nombreProducto')?.hasError('required')">
            Este campo es obligatorio.
          </mat-error>
          <mat-error *ngIf="nombreInvalido">Debes seleccionar un producto existente.</mat-error>
          <mat-autocomplete #productoAuto="matAutocomplete" autoActiveFirstOption>
            <mat-option *ngIf="cargandoSugerencias" class="text-muted" disabled>Cargando opciones...</mat-option>
            <mat-option *ngFor="let nombre of sugerenciasNombres" [value]="nombre">
              {{ nombre }}
            </mat-option>
            <mat-option *ngIf="!cargandoSugerencias && sugerenciasNombres.length === 0" disabled>
              Sin coincidencias
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-fill">
          <mat-label>Precio</mat-label>
          <input matInput type="number" min="0" step="0.01" formControlName="precioCompra" />
          <mat-error *ngIf="formulario.get('precioCompra')?.hasError('required')">
            El precio es obligatorio.
          </mat-error>
          <mat-error *ngIf="formulario.get('precioCompra')?.hasError('min')">
            Debe ser mayor a 0.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-fill">
          <mat-label>Cantidad</mat-label>
          <input matInput type="number" min="1" step="1" formControlName="cantidad" />
          <mat-error *ngIf="formulario.get('cantidad')?.hasError('required')">
            La cantidad es obligatoria.
          </mat-error>
          <mat-error *ngIf="formulario.get('cantidad')?.hasError('min')">
            Debe ser al menos 1.
          </mat-error>
        </mat-form-field>

      </div>

      <div class="d-flex justify-content-end mt-1">
        <button mat-stroked-button color="primary" type="button" (click)="agregarALista()">
          <i class="bi bi-plus-circle me-2"></i>
          Agregar a la lista
        </button>
      </div>
    </div>

    <div>
      <h6 class="fw-semibold text-uppercase small text-muted mb-2">Productos agregados</h6>
      <ng-container *ngIf="productosRegistrados.length > 0; else listaVacia">
        <div class="table-responsive">
          <table mat-table [dataSource]="productosRegistrados" class="table table-sm align-middle mb-0">
            <ng-container matColumnDef="nombre">
              <th mat-header-cell *matHeaderCellDef>Producto</th>
              <td mat-cell *matCellDef="let element">{{ element.nombreProducto }}</td>
            </ng-container>

            <ng-container matColumnDef="precio">
              <th mat-header-cell *matHeaderCellDef>Precio</th>
              <td mat-cell *matCellDef="let element">{{ element.precioCompra | number:'1.0-0' }}</td>
            </ng-container>

            <ng-container matColumnDef="cantidad">
              <th mat-header-cell *matHeaderCellDef>Cantidad</th>
              <td mat-cell *matCellDef="let element">{{ element.cantidad }}</td>
            </ng-container>

            <ng-container matColumnDef="acciones">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let element; let idx = index" class="text-end">
                <button mat-icon-button color="warn" type="button" (click)="eliminarProducto(idx)" aria-label="Eliminar producto">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['nombre', 'precio', 'cantidad', 'acciones']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['nombre', 'precio', 'cantidad', 'acciones'];"></tr>
          </table>
        </div>
      </ng-container>
      <ng-template #listaVacia>
        <p class="text-muted fst-italic mb-0">AÃºn no has agregado productos.</p>
      </ng-template>
    </div>
  </form>
</div>
<div mat-dialog-actions class="d-flex justify-content-end gap-2 mt-3">
  <button mat-button type="button" (click)="cancelar()">Cancelar</button>
  <button mat-flat-button color="primary" type="button" (click)="guardar()">Guardar</button>
</div>
