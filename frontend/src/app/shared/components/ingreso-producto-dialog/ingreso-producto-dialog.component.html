<section class="inventory-dialog">
  <header class="dialog-header">
    <div class="dialog-icon">
      <i class="bi bi-arrow-down-circle"></i>
    </div>
    <div>
      <h2 mat-dialog-title class="dialog-title">Registrar ingreso</h2>
      <p class="dialog-subtitle">Carga múltiples presentaciones a la vez para actualizar el stock masivamente.</p>
    </div>
  </header>
  <div mat-dialog-content class="dialog-content">
    <form [formGroup]="formulario" class="d-flex flex-column gap-4">
      <div class="inline-panel">
        <div class="inline-grid">
          <mat-form-field appearance="outline">
            <mat-label>Nombre del producto</mat-label>
            <input
              matInput
              placeholder="Ej. Aceite Premium"
              formControlName="nombreProducto"
              [matAutocomplete]="productoAuto"
              autocomplete="off"
              class="text-uppercase"
            />
            <mat-error *ngIf="formulario.get('nombreProducto')?.hasError('required')">
              Este campo es obligatorio.
            </mat-error>
            <mat-error *ngIf="nombreInvalido">Debes seleccionar un producto existente.</mat-error>
            <mat-autocomplete #productoAuto="matAutocomplete" autoActiveFirstOption>
              <mat-option *ngIf="cargandoSugerencias" class="text-muted" disabled>Cargando opciones...</mat-option>
              <mat-option *ngFor="let nombre of sugerenciasNombres" [value]="nombre" class="text-uppercase">
                {{ nombre }}
              </mat-option>
              <mat-option *ngIf="!cargandoSugerencias && sugerenciasNombres.length === 0" disabled>
                Sin coincidencias
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Precio por unidad</mat-label>
            <input matInput type="number" min="0" step="0.01" formControlName="precioCompra" />
            <mat-error *ngIf="formulario.get('precioCompra')?.hasError('required')">
              El precio es obligatorio.
            </mat-error>
            <mat-error *ngIf="formulario.get('precioCompra')?.hasError('min')">
              Debe ser mayor a 0.
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Cantidad</mat-label>
            <input matInput type="number" min="1" step="1" formControlName="cantidad" />
            <mat-error *ngIf="formulario.get('cantidad')?.hasError('required')">
              La cantidad es obligatoria.
            </mat-error>
            <mat-error *ngIf="formulario.get('cantidad')?.hasError('min')">
              Debe ser al menos 1.
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Fecha del ingreso</mat-label>
            <input matInput type="datetime-local" formControlName="fechaRegistro" />
            <mat-error *ngIf="formulario.get('fechaRegistro')?.hasError('required')">
              Debes especificar la fecha y hora.
            </mat-error>
            <mat-error *ngIf="formulario.get('fechaRegistro')?.hasError('invalid')">
              Formato de fecha inválido.
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Comentario</mat-label>
            <textarea
              matInput
              rows="1"
              placeholder="Observación del lote (opcional)"
              formControlName="comentario"
            ></textarea>
            <mat-hint>Opcional</mat-hint>
            <mat-error *ngIf="formulario.get('comentario')?.hasError('maxlength')">
              Máximo 250 caracteres.
            </mat-error>
          </mat-form-field>
        </div>

        <div class="inline-panel__actions">
          <button type="button" class="dialog-btn dialog-btn--primary dialog-btn--compact" (click)="agregarALista()">
            <i class="bi bi-plus-circle me-2"></i>
            Agregar a la lista
          </button>
        </div>
      </div>

      <div>
        <div class="section-heading">
          <div>
            <p class="section-heading__title">Productos agregados</p>
            <small class="text-muted">Total en lista: {{ productosRegistrados.length }}</small>
          </div>
        </div>
        <ng-container *ngIf="productosRegistrados.length > 0; else listaVacia">
          <div class="table-responsive rounded-3 border">
            <table mat-table [dataSource]="productosRegistrados" class="table table-sm align-middle mb-0">
              <ng-container matColumnDef="nombre">
                <th mat-header-cell *matHeaderCellDef>Producto</th>
                <td mat-cell *matCellDef="let element" class="text-uppercase">{{ element.nombreProducto }}</td>
              </ng-container>

              <ng-container matColumnDef="precio">
                <th mat-header-cell *matHeaderCellDef>Precio</th>
                <td mat-cell *matCellDef="let element">{{ element.precioCompra | number:'1.0-0' }}</td>
              </ng-container>

              <ng-container matColumnDef="cantidad">
                <th mat-header-cell *matHeaderCellDef>Cantidad</th>
                <td mat-cell *matCellDef="let element">{{ element.cantidad }}</td>
              </ng-container>

              <ng-container matColumnDef="comentario">
                <th mat-header-cell *matHeaderCellDef>Comentario</th>
                <td mat-cell *matCellDef="let element">{{ element.comentario || '—' }}</td>
              </ng-container>

              <ng-container matColumnDef="acciones">
                <th mat-header-cell *matHeaderCellDef></th>
                <td mat-cell *matCellDef="let element; let idx = index" class="text-end">
                  <button
                    type="button"
                    class="icon-button icon-button--danger"
                    (click)="eliminarProducto(idx)"
                    aria-label="Eliminar producto"
                  >
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['nombre', 'precio', 'cantidad', 'comentario', 'acciones']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['nombre', 'precio', 'cantidad', 'comentario', 'acciones'];"></tr>
            </table>
          </div>
        </ng-container>
        <ng-template #listaVacia>
          <p class="text-muted fst-italic mb-0">Aún no has agregado productos.</p>
        </ng-template>
      </div>
    </form>
  </div>
  <div mat-dialog-actions class="dialog-actions">
    <button type="button" class="dialog-btn dialog-btn--ghost" (click)="cancelar()">Cancelar</button>
    <button type="button" class="dialog-btn dialog-btn--primary" (click)="guardar()">Guardar</button>
  </div>
</section>
